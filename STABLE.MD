**Отчет по устойчивости и масштабированию**

**Краткое резюме**
Приложение функционально цельное, но при росте трафика и данных есть несколько точек риска: блокирующие операции в API, тяжёлые SQL‑запросы без ограничений, операции с большими данными в памяти и отсутствие контроля конкуренции в отдельных потоках (скриншоты, экспорт, выдача доступа). Эти места способны вызвать резкий рост латентности, исчерпание памяти и падение процесса.

**Что может “упасть” под высокой нагрузкой**

| Риск | Что происходит | Почему | Где видно |
|---|---|---|---|
| OOM / падение процесса | Экспорт карточек может съесть много памяти и положить процесс | ZIP собирается целиком в память, синхронные FS‑операции | `src/app/api/admin/export-cards/route.js` |
| Рост латентности / таймауты | Запросы миниаппа становятся очень медленными | Сложные подзапросы + offset‑pagination при больших данных | `src/app/api/miniapp/cards/route.js` |
| Очереди запросов к БД | База начинает отвечать медленнее, запросы висят | Малый `connectionLimit`, неограниченная очередь | `src/services/database.js` |
| Конкурентные гонки | Промокоды могут «перерасходоваться» | Проверка лимита и инкремент не атомарны | `src/app/api/miniapp/promocode/route.js`, `src/bot/bot.js` |
| Высокая нагрузка CPU/памяти | Скриншоты перегружают сервер | Puppeteer + огромный viewport + нет лимитов конкуренции | `src/app/api/miniapp/screenshot/route.js` |
| Блокировка event loop | Загрузка файлов “замораживает” Node | `fs.existsSync` и `fs.readFileSync` | `src/app/api/uploads/cards/[...path]/route.js` |
| Внешние сервисы подвешивают запрос | Оплаты/Telegram могут «залипать» | Нет таймаутов и ретраев для HTTP | `src/services/yookassa.js`, `src/app/api/miniapp/screenshot/route.js` |
| Ограниченная масштабируемость | Один процесс = узкое горлышко | `instances: 1`, нет кластеризации | `ecosystem.config.js` |

**Основные узкие места в данных и запросах**

1. `src/app/api/miniapp/cards/route.js`  
Тяжёлые запросы с `WITH latest_responses`, коррелированными подзапросами и `OFFSET`. При больших таблицах это быстро деградирует.

2. `src/app/api/admin/users/route.js`  
Сводная аналитика по пользователям через подзапросы и группировки. Под высокой нагрузкой это может “съедать” ресурс БД.

3. `src/app/api/admin/export-cards/route.js`  
Собирается весь архив в памяти и читаются файлы синхронно. Это критично при больших объемах карточек.

4. `src/app/api/miniapp/screenshot/route.js`  
Puppeteer создаёт страницы на каждый запрос, а скриншоты могут быть огромными. Без лимитирования это легко приводит к перегрузке.

**Что оптимизировать в первую очередь (быстрые победы)**

1. Ограничить размеры выборок и защититься от “огромных” лимитов.  
Файлы: `src/app/api/miniapp/cards/route.js`, `src/app/api/admin/users/route.js`, `src/app/api/admin/cards/list/route.js`.  
Решение: жёсткие лимиты (например 100), валидация `page/limit`.

2. Убрать блокирующий FS и большие буферы.  
Файлы: `src/app/api/admin/export-cards/route.js`, `src/app/api/uploads/cards/[...path]/route.js`.  
Решение: стриминг ZIP в ответ, `fs.createReadStream`, отдача статики через веб‑сервер.

3. Сделать выдачу промокодов атомарной.  
Файлы: `src/app/api/miniapp/promocode/route.js`, `src/bot/bot.js`.  
Решение: `UPDATE promo_codes SET current_uses = current_uses + 1 WHERE id = ? AND current_uses < max_uses` и проверка `affectedRows`.

4. Добавить лимиты на генерацию скриншотов.  
Файл: `src/app/api/miniapp/screenshot/route.js`.  
Решение: очередь задач или семафор на 1–2 параллельных страницы, отдельный воркер.

5. Таймауты и ретраи для внешних сервисов.  
Файл: `src/services/yookassa.js`.  
Решение: `timeout`, ограниченные ретраи, логика отказоустойчивости.

**Среднесрочные улучшения**

1. Переписать тяжелые запросы на keyset‑pagination вместо `OFFSET`.  
Файл: `src/app/api/miniapp/cards/route.js`.

2. Вынести тяжелые задачи в фоновые процессы.  
Файлы: `src/app/api/admin/export-cards/route.js`, `src/app/api/miniapp/screenshot/route.js`.

3. Проверить и добавить необходимые индексы.  
Критичные: `user_card_access(user_id, card_id, is_active, expires_at)`, `user_responses(user_id, card_id, response_time)`, `promo_codes(code)`.

4. Ограничить параллелизм и масштабировать через PM2.  
Файл: `ecosystem.config.js`.  
Решение: отдельный процесс для Puppeteer и экспорта, кластер для Next.

**Дополнительные наблюдения**

1. `src/app/api/miniapp/cards/route.js` возвращает `sql` и `countSql` в ответе. Это лишняя нагрузка и потенциальное раскрытие внутренней логики.  
2. В `src/services/database.js` `connectionLimit: 10` и `queueLimit: 0` могут создавать длинные очереди и рост латентности при всплесках.

**Рекомендуемые минимальные метрики**
1. Время ответа API (p95/p99) по ключевым маршрутам.  
2. Количество активных соединений к БД и глубина очередей.  
3. Ошибки `ER_LOCK_WAIT_TIMEOUT` и `ETIMEDOUT`.  
4. Потребление памяти процесса Node при экспорте и скриншотах.

Если хотите, я могу подготовить отдельный технический план внедрения оптимизаций и приоритизацию задач по сложности.